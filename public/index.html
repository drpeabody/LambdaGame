<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>The Lambda Game</title>
	<style type="text/css">
		body {
			background: #112;
		}
		canvas {
			border : 0px;
		}
		#login-form {
			color: #fff;
			margin-top: 40vh;
			text-align: center;
		}
		.row {
			overflow-x: hidden;
			width: 100%;
			margin: 40px 0 0 0;
		}
		.label {
			font-size: 2em;
			margin-bottom: 5vh;
		}
	</style>
</head>
<body>
	<div id="login-form">
		<label id="input-form-label" class="label">Enter your username if you are logging in for the First Time, or your Hash Key if you already have an account. </label>
		<div class="row">
			Username: <input type="text" name="UserName" id="username">
		</div>

		<div class="row">
			Key : <input type="Password" name="Password" id="password">
		</div>
		<div class="row">
			<input type="button" value="Register" id="btn-register">
			<input type="button" value="Login" id="btn-login">
		</div>
	</div>
	<canvas id="fuckyou"></canvas>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
<script type="text/javascript">
	g = (id) => document.getElementById(id);
	var hasAskedOnce = false;
	var playerSquareSize = 50;
	var correctionFactor = 0.95 ;
	var playerSquareDimensions = 10 ;
	var MapSize = 100000 ;
	var curId;
	canvas = document.getElementById("fuckyou");

	var player = null;
	function User(x,y,cameraX, cameraY)
{
	return {
        x : x ,
        y : y ,
        cameraX : cameraX ,
        cameraY : cameraY ,
        bwDown : false ,
        bADown : false ,
        bSDown : false ,
        bDDown : false 
    }
}
	var user = null  ;
	/*player = {
					x: data.UserPositionX, y: data.UserPositionY,
					cameraX: (data.UserPositionX + playerSquareDimensions/2 - canvas.width/2),
					cameraY: (data.UserPositionY + playerSquareDimensions/2 - canvas.height/2),
					bWDown: false, bADown: false, bSDown: false, bDDown: false //Input Tracking var
				};*/
	connect = (id) => {
		// io.origins('*:*');
		// socket = io('http://192.168.0.130:8080/', {id: id});
		socket = io('http://localhost:8080/', {id: id});
		socket.emit('Username', {id: id, windowWidth : (window.innerWidth * correctionFactor), windowHeight : (window.innerHeight*correctionFactor)});
		socket.on('AccountExists', function(doesAccountExist) {
			g('input-form-label').innerHTML = 'This username already exists';
		});
		socket.on('UserId', function(plr){
			var elem = document.getElementById("login-form");
			elem.parentNode.removeChild(elem);
            player = User(plr.x, plr.y, plr.cameraX, plr.cameraY);
            console.log("UserId received");
            curId = plr.ID ;
            document.onkeydown = (e) => {
				// console.log("Key Pressed " + e.key);
				var key = e.key ;
				if ((key === 'w')||(key === 'W')) player.bWDown = true ;
				if ((key === 'a')||(key === 'A')) player.bADown = true ;
				if ((key === 's')||(key === 'S')) player.bSDown = true ;
				if ((key === 'd')||(key === 'D')) player.bDDown = true ;
			}

			document.onkeyup = (e) => {
				var key = e.key ;
				if ((key === 'w')||(key === 'W')) player.bWDown = false ;
				if ((key === 'a')||(key === 'A')) player.bADown = false ;
				if ((key === 's')||(key === 'S')) player.bSDown = false ;
				if ((key === 'd')||(key === 'D')) player.bDDown = false ;
			}
			update();
		})
		draw = (data) => {
				
				// Figure out better way ?
				// for (var i = 0 ; i < canvas.width ; i++)
				// {
				// 	for (var j = 0 ; j < canvas.height ; j++)
				// 	{
				// 		if ((player.x + i) >= 0 && (player.x + i) <= MapSize && (player.y + j) >= 0 && (player.y + j) <= MapSize)
				// 		{
				// 			ctx.fillStyle = "#113311";
				// 			ctx.fillRect(i, j, 1, 1);
				// 		}
				// 		else
				// 		{		
				// 			ctx.fillStyle = "#000000";	
				// 			ctx.fillRect(i, j, 1, 1);
				// 		}
				// 	}
				// }

				////Code duplication here should be fixed!!!!!
								canvas.width = window.innerWidth * correctionFactor;
				canvas.height = window.innerHeight * correctionFactor;
				ctx = canvas.getContext('2d');

				
				ctx.fillStyle = "#113311";
				ctx.fillRect(0,0,canvas.width,canvas.height);

				if (player.cameraX < 0 )
				{
					ctx.fillStyle = "#000000";
					ctx.fillRect(0,0,-player.cameraX, canvas.height);
				}
				if (player.cameraY < 0 )
				{
					ctx.fillStyle = "#000000";
					ctx.fillRect(0,0,canvas.width, -player.cameraY);
				}
				if (player.cameraY + canvas.height >= MapSize)
				{
					ctx.fillStyle = "#000000";
					ctx.fillRect(0,MapSize - player.cameraY,canvas.width, canvas.height- (MapSize - player.cameraY));
				}
				if (player.cameraX + canvas.width >= MapSize)
				{
					ctx.fillStyle = "#000000";
					ctx.fillRect(MapSize - player.cameraX, 0, canvas.width - (MapSize - player.cameraX), canvas.height);
				}
				ctx.fillStyle = "#441111";
				ctx.fillRect((canvas.width- playerSquareDimensions )/2, (canvas.height- playerSquareDimensions )/2, playerSquareDimensions, playerSquareDimensions);

				// ctx.fillStyle = "#111199";
				// ctx.fillRect(tree.x - player.x, tree.y - player.y, 20, 20);
				console.log(data.ObjectList[0]);
				for (var i = 0 ; i < data.ObjectList.length ; i++)
				{

					if (data.ObjectList[i].x >= player.cameraX && data.ObjectList[i].x <= (player.cameraX + canvas.width) && data.ObjectList[i].y >= player.cameraY && data.ObjectList[i].y <= (player.cameraY + canvas.height))
					{
						console.log("This object has been rendered.")
						ctx.fillStyle = data.ObjectList[i].color ;
						ctx.fillRect(data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y - player.cameraY, data.ObjectList[i].l, data.ObjectList[i].b);
					}
				}

				//update();
			}
			update = () => {
				//Sync with server - All Socet.emit here
				//Process input

				var speed = 5 ;
				var verificationSquareSize = 300 * speed ;
				// Temporary Fix : 
				// if (Math.abs(player.x - data.UserPositionX) <= verificationSquareSize && Math.abs(player.y - data.UserPositionY) <= verificationSquareSize)
				if (true)
				{
					console.log("Updating coords");
					console.log(player.y+playerSquareDimensions+speed, MapSize);
					if (player.bWDown && (player.y - speed>= 0)){
						player.y -= speed; player.cameraY -= speed ;
					}
					if (player.bADown && (player.x - speed>= 0)){
						player.x -= speed; player.cameraX -= speed ;
					}
					if (player.bSDown && (player.y + playerSquareDimensions + speed <= MapSize)){
						player.y += speed; player.cameraY += speed ;
					}
					if (player.bDDown && (player.x + playerSquareDimensions + speed) <= MapSize){ 
						player.x += speed; player.cameraX += speed ;
					}
					socket.emit('UpdateCoords', {x:player.x, y:player.y, ID:curId});
				}
				requestAnimationFrame(update);

				// Figure out some way of verification server-side
			}
		socket.on('MapGen', function(data) {
			// Clear the div out
			console.log("MapGen received");
			// var elem = document.getElementById("login-form");
			// elem.parentNode.removeChild(elem);
			// Init canvas
			canvas = document.getElementById("fuckyou");
			canvas.width = window.innerWidth * correctionFactor;
			canvas.height = window.innerHeight * correctionFactor;
			ctx = canvas.getContext('2d');

			player = {
				x: data.UserPositionX, y: data.UserPositionY,
				cameraX: (data.UserPositionX + playerSquareDimensions/2 - canvas.width/2),
				cameraY: (data.UserPositionY + playerSquareDimensions/2 - canvas.height/2),
				bWDown: false, bADown: false, bSDown: false, bDDown: false //Input Tracking var
			}

			// tree = {
			// 	// x: Math.random()*mapSize, y: Math.random()*mapSize
			// 	x: player.x + 30, y: player.y + 30
			// }

			draw(data);	
		});

		//update();

		// socket.on('news', function (data) {
		// 	console.log(data);
		// 	socket.emit('my other event', { my: 'data' });
		// });
	}
	// connectPwd = (pwd) => {
	// 	// io.origins('*:*');
	// 	// socket = io('http://192.168.110.68:8080/', {id: id, pwd: pwd});
	// 	socket = io('http://localhost:8080/', {pwd: pwd});
	// 	socket.on('news', function (data) {
	// 		console.log(data);
	// 		socket.emit('my other event', { my: 'data' });
	// 	});
	// }

	g('btn-register').addEventListener('click', () => {
		var name = g('username').value;
		if(!name|| name === ''){
			g('input-form-label').innerHTML = 'Please Enter a valid Username';
			return;
		}
		if(hasAskedOnce){
			g('input-form-label').innerHTML = 'Please wait while we register you with our servers.';
			connect(name);
		} else {
			g('input-form-label').innerHTML = 'Please Reconfirm Your Password (without your '+
			'password you will lose access to your inventory) and click Register again.';
			hasAskedOnce = true;
		}
	});

	g('btn-login').addEventListener('click', () => {
		// var pass = g('password').value ;
		// if (!pass || pass === '')
		// {
		// 	g('input-form-label').innerHTML = 'Please enter a valid password';
		// 	return ;
		// }

	});
</script>
</html>