<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>The Lambda Game</title>
	<style type="text/css">
		h1 {
			color: 	#fff;
		}	
		body {
			background: linear-gradient(#224, #112);
		}
		canvas {
			border : 0px;
		}
		#login-form {
			color: #fff;
			margin-top: 20vh;
			text-align: center;
		}
		.row {
			overflow-x: hidden;
			width: 100%;
			margin: 40px 0 0 0;
		}
		.label {
			font-size: 2em;
			margin-bottom: 5vh;
		}
		.btn {
			margin: 1%; 
			padding: 1%;
			display: inline-flex;
			background: #484;
			align-content: center;
			border: none;
			border-radius: 1vw;
			cursor: pointer;
			-webkit-touch-callout: none; /* iOS Safari */
			-webkit-user-select: none; /* Safari */
			-khtml-user-select: none; /* Konqueror HTML */
			-moz-user-select: none; /* Firefox */
			-ms-user-select: none; /* Internet Explorer/Edge */
			user-select: none; /* Non-prefixed version, currently
			                  supported by Chrome and Opera */
		}
	</style>
</head>
<body>
	<div id="login-form">
		<h1> Welcome to the Lambda Game. </h1>
		<label id="input-form-label" class="label">  You must Register or Login to continue. </label>
		<div class="row">
			Username: <input type="text" name="UserName" id="username">
		</div>
		<div class="row">
			Password: <input type="Password" name="Password" id="password">
		</div>
		<div class="row">
			<div class="btn" value="Register" id="btn-register"> Register  </div>
			<div class="btn" value="Login" id="btn-login"> Login  </div>
		</div>
	</div>
	<canvas id="fuckyou"></canvas>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
<script type="text/javascript">
	g = (id) => document.getElementById(id);
	request = (method, url, data, callback) => {
		var httpRequest = new XMLHttpRequest();
		
		if(!httpRequest) {
			alert('Please use a web browser of this age.');
			return false;
		}

		httpRequest.onreadystatechange = callback;
		httpRequest.open(method, url);
    	httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
		httpRequest.send(JSON.stringify(data));
		return httpRequest;
	}
	url = 'http://localhost:8080';

	var playerSquareSize = 50;
	var correctionFactor = 0.95;

	connect = (id) => {
		// io.origins('*:*');
		// socket = io('http://192.168.0.130:8080/', {id: id});
		socket = io('http://localhost:8080/', {id: id});
		socket.emit('Username', {id: id, windowWidth : (window.innerWidth * correctionFactor), windowHeight : (window.innerHeight*correctionFactor)});
		socket.on('AccountExists', function(doesAccountExist) {
			g('input-form-label').innerHTML = 'This username already exists';
		});
		socket.on('MapGen', function(data) {
			// Clear the div out
			var elem = document.getElementById("login-form");
			elem.parentNode.removeChild(elem);
			// Init canvas
			canvas = document.getElementById("fuckyou");
			canvas.width = window.innerWidth * correctionFactor;
			canvas.height = window.innerHeight * correctionFactor;
			ctx = canvas.getContext('2d');
			mapSize = 4000;

			player = {
				x: data.UserPositionX, y: data.UserPositionY,
				bWDown: false, bADown: false, bSDown: false, bDDown: false //Input Tracking var
			}

			// tree = {
			// 	// x: Math.random()*mapSize, y: Math.random()*mapSize
			// 	x: player.x + 30, y: player.y + 30
			// }

			document.onkeydown = (e) => {
				// console.log("Key Pressed " + e.key);
				var key = e.key ;
				if ((key === 'w')) player.bWDown = true ;
				if ((key === 'a')) player.bADown = true ;
				if ((key === 's')) player.bSDown = true ;
				if ((key === 'd')) player.bDDown = true ;
			}

			document.onkeyup = (e) => {
				var key = e.key ;
				if ((key === 'w')) player.bWDown = false ;
				if ((key === 'a')) player.bADown = false ;
				if ((key === 's')) player.bSDown = false ;
				if ((key === 'd')) player.bDDown = false ;
			}

			draw = () => {

				ctx.fillStyle = "#113311";
				ctx.fillRect(0, 0, canvas.width, canvas.height);

				ctx.fillStyle = "#441111";
				ctx.fillRect(canvas.width/2, canvas.height/2, 10, 10);

				// ctx.fillStyle = "#111199";
				// ctx.fillRect(tree.x - player.x, tree.y - player.y, 20, 20);

				for (var i = 0 ; i < data.ObjectList.length ; i++)
				{
					if (data.ObjectList[i].x >= player.x && data.ObjectList[i].x <= (player.x + canvas.width) && data.ObjectList[i].y >= player.y && data.ObjectList[i].y <= (player.y + canvas.height))
					{
						console.log("This object has been rendered.")
						ctx.fillStyle = data.ObjectList[i].color ;
						ctx.fillRect(data.ObjectList[i].x - player.x, data.ObjectList[i].y - player.y, data.ObjectList[i].l, data.ObjectList[i].b);
					}
				}

				requestAnimationFrame(draw);

				update();
			}

			update = () => {
				//Sync with server - All Socet.emit here
				//Process input

				var speed = 5 ;
				var verificationSquareSize = 300 * speed ;
				// Temporary Fix : 
				// if (Math.abs(player.x - data.UserPositionX) <= verificationSquareSize && Math.abs(player.y - data.UserPositionY) <= verificationSquareSize)
				if (true)
				{
					if (player.bWDown) {player.y -= speed; socket.emit('UpdateCoords', {x:player.x , y:player.y , ID : data.curId});}
					if (player.bADown) {player.x -= speed; socket.emit('UpdateCoords', {x:player.x , y:player.y , ID : data.curId});}
					if (player.bSDown) {player.y += speed; socket.emit('UpdateCoords', {x:player.x , y:player.y , ID : data.curId});}
					if (player.bDDown) {player.x += speed; socket.emit('UpdateCoords', {x:player.x , y:player.y , ID : data.curId});}
				}
				// Figure out some way of verification server-side
				//socket.emit('requestMap', x, y, width,height)
			}
			draw();

			// draw();
		});
		// socket.on('news', function (data) {
		// 	console.log(data);
		// 	socket.emit('my other event', { my: 'data' });
		// });
	}

	g('btn-register').addEventListener('click', () => {
		var name = g('username').value;
		var pwd = g('password').value;

		if(!name || name === ''){
			g('input-form-label').innerHTML = 'Please Enter a valid Username';
			return;
		}
		if(!pwd || pwd === '' || pwd.length < 8){
			g('input-form-label').innerHTML = 'Please Enter a valid Password of at least 8 characters.';
			return;
		}

		var req = request('POST', url + '/register', { username: name, pwd: pwd }, (val) => {
			if(!req || req.readyState !== 4) return;
			if(req.responseText === 'Registered'){
				//Successfully Registered, Login
				g('btn-login').click();
			}
			else {
				g('input-form-label').innerHTML = req.responseText;
			}
		});

	});

	g('btn-login').addEventListener('click', () => {
		var name = g('username').value;
		var pwd = g('password').value;

		if(!name || name === ''){
			g('input-form-label').innerHTML = 'Please Enter a valid Username';
			return;
		}
		if(!pwd || pwd === '' || pwd.length < 8){
			g('input-form-label').innerHTML = 'Please Enter a valid Password of at least 8 characters.';
			return;
		}

		var req = request('POST', url + '/login', { username: name, pwd: pwd }, (val) => {
			if(!req || req.readyState !== 4) return;
			console.log(req.responseText);
		});

	});
</script>
</html>