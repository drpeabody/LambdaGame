<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>The Lambda Game</title>
	<style type="text/css">
		body {
			background: #112;
		}
		canvas {
			border : 0px;
		}
		#login-form {
			color: #fff;
			margin-top: 40vh;
			text-align: center;
		}
		.row {
			overflow-x: hidden;
			width: 100%;
			margin: 40px 0 0 0;
		}
		.label {
			font-size: 2em;
			margin-bottom: 5vh;
		}
	</style>
</head>
<body>
	<div id="login-form">
		<label id="input-form-label" class="label">Enter your username if you are logging in for the First Time, or your Hash Key if you already have an account. </label>
		<div class="row">
			Username: <input type="text" name="UserName" id="username">
		</div>

		<div class="row">
			Key : <input type="Password" name="Password" id="password">
		</div>
		<div class="row">
			<input type="button" value="Register" id="btn-register">
			<input type="button" value="Login" id="btn-login">
		</div>
	</div>
	<canvas id="fuckyou"></canvas>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
<script type="text/javascript">
	g = (id) => document.getElementById(id);
	var hasAskedOnce = false;
	var playerSquareSize = 50;
	var correctionFactor = 0.95 ;
	var playerSquareDimensions = 10 ;
	var MapSize = 100000 ;
	connect = (id) => {
		// io.origins('*:*');
		// socket = io('http://192.168.0.130:8080/', {id: id});
		socket = io('http://localhost:8080/', {id: id});
		socket.emit('Username', {id: id, windowWidth : (window.innerWidth * correctionFactor), windowHeight : (window.innerHeight*correctionFactor)});
		socket.on('AccountExists', function(doesAccountExist) {
			g('input-form-label').innerHTML = 'This username already exists';
		});
		socket.on('MapGen', function(data) {
			// Clear the div out
			var elem = document.getElementById("login-form");
			elem.parentNode.removeChild(elem);
			// Init canvas
			canvas = document.getElementById("fuckyou");
			canvas.width = window.innerWidth * correctionFactor;
			canvas.height = window.innerHeight * correctionFactor;
			ctx = canvas.getContext('2d');
			mapSize = 4000;

			player = {
				x: data.UserPositionX, y: data.UserPositionY,
				bWDown: false, bADown: false, bSDown: false, bDDown: false //Input Tracking var
			}

			// tree = {
			// 	// x: Math.random()*mapSize, y: Math.random()*mapSize
			// 	x: player.x + 30, y: player.y + 30
			// }

			document.onkeydown = (e) => {
				// console.log("Key Pressed " + e.key);
				var key = e.key ;
				if ((key === 'w')) player.bWDown = true ;
				if ((key === 'a')) player.bADown = true ;
				if ((key === 's')) player.bSDown = true ;
				if ((key === 'd')) player.bDDown = true ;
			}

			document.onkeyup = (e) => {
				var key = e.key ;
				if ((key === 'w')) player.bWDown = false ;
				if ((key === 'a')) player.bADown = false ;
				if ((key === 's')) player.bSDown = false ;
				if ((key === 'd')) player.bDDown = false ;
			}

			draw = () => {
				
				// Figure out better way ?
				// for (var i = 0 ; i < canvas.width ; i++)
				// {
				// 	for (var j = 0 ; j < canvas.height ; j++)
				// 	{
				// 		if ((player.x + i) >= 0 && (player.x + i) <= MapSize && (player.y + j) >= 0 && (player.y + j) <= MapSize)
				// 		{
				// 			ctx.fillStyle = "#113311";
				// 			ctx.fillRect(i, j, 1, 1);
				// 		}
				// 		else
				// 		{		
				// 			ctx.fillStyle = "#000000";	
				// 			ctx.fillRect(i, j, 1, 1);
				// 		}
				// 	}
				// }
				ctx.fillStyle = "#113311";
				ctx.fillRect(0,0,canvas.width,canvas.height);

				ctx.fillStyle = "#441111";
				ctx.fillRect((canvas.width- playerSquareDimensions )/2, (canvas.height- playerSquareDimensions )/2, playerSquareDimensions, playerSquareDimensions);

				// ctx.fillStyle = "#111199";
				// ctx.fillRect(tree.x - player.x, tree.y - player.y, 20, 20);

				for (var i = 0 ; i < data.ObjectList.length ; i++)
				{
					if (data.ObjectList[i].x >= player.x && data.ObjectList[i].x <= (player.x + canvas.width) && data.ObjectList[i].y >= player.y && data.ObjectList[i].y <= (player.y + canvas.height))
					{
						console.log("This object has been rendered.")
						ctx.fillStyle = data.ObjectList[i].color ;
						ctx.fillRect(data.ObjectList[i].x - player.x, data.ObjectList[i].y - player.y, data.ObjectList[i].l, data.ObjectList[i].b);
					}
				}

				requestAnimationFrame(draw);

				update();
			}

			update = () => {
				//Sync with server - All Socet.emit here
				//Process input

				var speed = 5 ;
				var verificationSquareSize = 300 * speed ;
				// Temporary Fix : 
				// if (Math.abs(player.x - data.UserPositionX) <= verificationSquareSize && Math.abs(player.y - data.UserPositionY) <= verificationSquareSize)
				if (true)
				{
					if (player.bWDown && ((player.y - playerSquareDimensions) >= 0)) {player.y -= speed; socket.emit('UpdateCoords', {x:player.x , y:player.y , ID : data.curId});}
					if (player.bADown && ((player.x - playerSquareDimensions >= 0))) {player.x -= speed; socket.emit('UpdateCoords', {x:player.x , y:player.y , ID : data.curId});}
					if (player.bSDown && (player.y + playerSquareDimensions <= MapSize)) {player.y += speed; socket.emit('UpdateCoords', {x:player.x , y:player.y , ID : data.curId});}
					if (player.bDDown && (player.x + playerSquareDimensions) <= MapSize) {player.x += speed; socket.emit('UpdateCoords', {x:player.x , y:player.y , ID : data.curId});}
				}
				// Figure out some way of verification server-side
			}

			draw();
		});
		// socket.on('news', function (data) {
		// 	console.log(data);
		// 	socket.emit('my other event', { my: 'data' });
		// });
	}
	// connectPwd = (pwd) => {
	// 	// io.origins('*:*');
	// 	// socket = io('http://192.168.110.68:8080/', {id: id, pwd: pwd});
	// 	socket = io('http://localhost:8080/', {pwd: pwd});
	// 	socket.on('news', function (data) {
	// 		console.log(data);
	// 		socket.emit('my other event', { my: 'data' });
	// 	});
	// }

	g('btn-register').addEventListener('click', () => {
		var name = g('username').value;
		if(!name|| name === ''){
			g('input-form-label').innerHTML = 'Please Enter a valid Username';
			return;
		}
		if(hasAskedOnce){
			g('input-form-label').innerHTML = 'Please wait while we register you with our servers.';
			connect(name);
		} else {
			g('input-form-label').innerHTML = 'Please Reconfirm Your Password (without your '+
			'password you will lose access to your inventory) and click Register again.';
			hasAskedOnce = true;
		}
	});

	g('btn-login').addEventListener('click', () => {
		// var pass = g('password').value ;
		// if (!pass || pass === '')
		// {
		// 	g('input-form-label').innerHTML = 'Please enter a valid password';
		// 	return ;
		// }

	});
</script>
</html>