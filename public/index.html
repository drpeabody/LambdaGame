<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>The Lambda Game</title>
	<style type="text/css">
		h1 {
			color: 	#fff;
		}	
		body {
			background: linear-gradient(#224, #112);
		}
		canvas {
			border : 0px;
		}
		#login-form {
			color: #fff;
			margin-top: 20vh;
			text-align: center;
		}
		.row {
			overflow-x: hidden;
			width: 100%;
			margin: 40px 0 0 0;
		}
		.label {
			font-size: 2em;
			margin-bottom: 5vh;
		}
		.btn {
			margin: 1%; 
			padding: 1%;
			display: inline-flex;
			background: #484;
			align-content: center;
			border: none;
			border-radius: 1vw;
			cursor: pointer;
			-webkit-touch-callout: none; /* iOS Safari */
			-webkit-user-select: none; /* Safari */
			-khtml-user-select: none; /* Konqueror HTML */
			-moz-user-select: none; /* Firefox */
			-ms-user-select: none; /* Internet Explorer/Edge */
			user-select: none; /* Non-prefixed version, currently
			                  supported by Chrome and Opera */
		}
	</style>
</head>
<body>
	<div id="login-form">
		<h1> Welcome to the Lambda Game. </h1>
		<label id="input-form-label" class="label">  You must Register or Login to continue. </label>
		<div class="row">
			Username: <input type="text" name="UserName" id="username">
		</div>
		<div class="row">
			Password: <input type="Password" name="Password" id="password">
		</div>
		<div class="row">
			<div class="btn" value="Register" id="btn-register"> Register  </div>
			<div class="btn" value="Login" id="btn-login"> Login  </div>
		</div>
	</div>
	<canvas id="fuckyou"></canvas>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
<script type="text/javascript">
	g = (id) => document.getElementById(id);
	request = (method, url, data, callback) => {
		var httpRequest = new XMLHttpRequest();
		
		if(!httpRequest) {
			alert('Please use a web browser of this age.');
			return false;
		}

		httpRequest.onreadystatechange = callback;
		httpRequest.open(method, url);
    	httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
		httpRequest.send(JSON.stringify(data));
		return httpRequest;
	}
	url = 'http://192.168.0.103:8080';

	var hasAskedOnce = false;
	var playerSquareSize = 50;
	var correctionFactor = 0.95 ;
	var playerSquareDimensions = playerSquareSize ;
	var MapSize = 100000 ;
	var curId;
	canvas = document.getElementById("fuckyou");

	var player = null;
	function User(x,y,cameraX, cameraY)
{
	return {
        x : x ,
        y : y ,
        cameraX : cameraX ,
        cameraY : cameraY ,
        bwDown : false ,
        bADown : false ,
        bSDown : false ,
        bDDown : false 
    }
}
	var user = null  ;

	connect = (id) => {
		// io.origins('*:*');
		// socket = io('http://192.168.0.130:8080/', {id: id});
		socket = io(url, {id: id});
		socket.emit('Username', {id: id, windowWidth : (window.innerWidth * correctionFactor), windowHeight : (window.innerHeight*correctionFactor)});
		socket.on('AccountExists', function(doesAccountExist) {
			g('input-form-label').innerHTML = 'This username already exists';
		});
		socket.on('UserId', function(plr){
			var elem = document.getElementById("login-form");
			elem.parentNode.removeChild(elem);
            player = User(plr.x, plr.y, plr.cameraX, plr.cameraY);
            canvas = document.getElementById("fuckyou");
			ctx = canvas.getContext('2d');
			canvas.width = window.innerWidth * correctionFactor;
			canvas.height = window.innerHeight * correctionFactor;
            curId = plr.ID ;
            document.onkeydown = (e) => {
				// console.log("Key Pressed " + e.key);
				var key = e.key ;
				if ((key === 'w')||(key === 'W')) player.bWDown = true ;
				if ((key === 'a')||(key === 'A')) player.bADown = true ;
				if ((key === 's')||(key === 'S')) player.bSDown = true ;
				if ((key === 'd')||(key === 'D')) player.bDDown = true ;
			}

			document.onkeyup = (e) => {
				var key = e.key ;
				if ((key === 'w')||(key === 'W')) player.bWDown = false ;
				if ((key === 'a')||(key === 'A')) player.bADown = false ;
				if ((key === 's')||(key === 'S')) player.bSDown = false ;
				if ((key === 'd')||(key === 'D')) player.bDDown = false ;
			}
			update();
		});
		draw = (data) => {
				
				// Figure out better way ?
				// for (var i = 0 ; i < canvas.width ; i++)
				// {
				// 	for (var j = 0 ; j < canvas.height ; j++)
				// 	{
				// 		if ((player.x + i) >= 0 && (player.x + i) <= MapSize && (player.y + j) >= 0 && (player.y + j) <= MapSize)
				// 		{
				// 			ctx.fillStyle = "#113311";
				// 			ctx.fillRect(i, j, 1, 1);
				// 		}
				// 		else
				// 		{		
				// 			ctx.fillStyle = "#000000";	
				// 			ctx.fillRect(i, j, 1, 1);
				// 		}
				// 	}
				// }
				////Code duplication here should be fixed!!!!!
				ctx = canvas.getContext('2d');

				
				ctx.fillStyle = "#113311";
				ctx.fillRect(0,0,canvas.width,canvas.height);
				// Work on this   ()()()(CIP)
				// if (player.cameraX < 0 )
				// {
				// 	ctx.fillStyle = "#000000";
				// 	ctx.fillRect(0,0,-player.cameraX, canvas.height);
				// }
				// if (player.cameraY < 0 )
				// {
				// 	ctx.fillStyle = "#000000";
				// 	ctx.fillRect(0,0,canvas.width, -player.cameraY);
				// }
				// if (player.cameraY + canvas.height >= MapSize)
				// {
				// 	ctx.fillStyle = "#000000";
				// 	ctx.fillRect(0,MapSize - player.cameraY,canvas.width, canvas.height- (MapSize - player.cameraY));
				// }
				// if (player.cameraX + canvas.width >= MapSize)
				// {
				// 	ctx.fillStyle = "#000000";
				// 	ctx.fillRect(MapSize - player.cameraX, 0, canvas.width - (MapSize - player.cameraX), canvas.height);
				// }
				ctx.fillStyle = "#441111";
				ctx.fillRect((canvas.width- playerSquareDimensions )/2, (canvas.height- playerSquareDimensions )/2, playerSquareDimensions, playerSquareDimensions);

				// ctx.fillStyle = "#111199";
				// ctx.fillRect(tree.x - player.x, tree.y - player.y, 20, 20);
				for (var i = 0 ; i < data.ObjectList.length ; i++)
				{

					/*if (data.ObjectList[i].x >= player.cameraX && data.ObjectList[i].x <= (player.cameraX + canvas.width) && data.ObjectList[i].y >= player.cameraY && data.ObjectList[i].y <= (player.cameraY + canvas.height))*/
					{
						var color = "";
						
						switch(data.ObjectList[i].type)
						{
							case 0: 
								color = "#441111";
							break ;
							case 1:
								color = "#42692f";
							break ;
							case 2 :
								color = "#000000";
							break;
						}
						ctx.fillStyle = color ;
						ctx.fillRect(data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y - player.cameraY, data.ObjectList[i].width, data.ObjectList[i].height);
					}
					
				}

				//update();
			}
			update = () => {
				//Sync with server - All Socet.emit here
				//Process input
				var speed = 5 ;
				var verificationSquareSize = 300 * speed ;
				// Temporary Fix : 
				// if (Math.abs(player.x - data.UserPositionX) <= verificationSquareSize && Math.abs(player.y - data.UserPositionY) <= verificationSquareSize)
				/*if (true)
				{
					console.log("Updating coords");
					console.log(player.x, player.y);
					if (player.bWDown && (player.y - speed>= 0)){
						player.y -= speed; player.cameraY -= speed ;
					}
					if (player.bADown && (player.x - speed>= 0)){
						player.x -= speed; player.cameraX -= speed ;
					}
					if (player.bSDown && (player.y + playerSquareDimensions + speed <= MapSize)){
						player.y += speed; player.cameraY += speed ;
					}
					if (player.bDDown && (player.x + playerSquareDimensions + speed) <= MapSize){ 
						player.x += speed; player.cameraX += speed ;
					}
					socket.emit('UpdateCoords', {x:player.x, y:player.y, ID:curId, cameraX: player.cameraX, cameraY:player.cameraY, canvasWidth:canvas.width, canvasHeight:canvas.height});
				}*/
				socket.emit('UpdateCoords', {bWDown: player.bWDown, bSDown: player.bSDown, bADown:player.bADown, bDDown: player.bDDown, ID:curId, cameraX: player.cameraX, cameraY:player.cameraY, canvasWidth:canvas.width, canvasHeight:canvas.height});
				requestAnimationFrame(update);

				// Figure out some way of verification server-side
			}
	socket.on('MapGen', function(data) {
			// Clear the div out
			// var elem = document.getElementById("login-form");
			// elem.parentNode.removeChild(elem);
			// Init canvas
			
			player.x = data.UserPositionX;
			player.y = data.UserPositionY;
			player.cameraX = data.UserPositionX + playerSquareDimensions/2 - canvas.width/2;
			player.cameraY = (data.UserPositionY + playerSquareDimensions/2 - canvas.height/2);
			 /*= {
				x: data.UserPositionX, y: data.UserPositionY,
				cameraX: (data.UserPositionX + playerSquareDimensions/2 - canvas.width/2),
				cameraY: (data.UserPositionY + playerSquareDimensions/2 - canvas.height/2),
				bWDown: player.bWDown, bADown: player., bSDown: false, bDDown: false //Input Tracking var
			};*/
			// tree = {
			// 	// x: Math.random()*mapSize, y: Math.random()*mapSize
			// 	x: player.x + 30, y: player.y + 30
			// }

			draw(data);	
		});
}
	g('btn-register').addEventListener('click', () => {
		var name = g('username').value;
		var pwd = g('password').value;

		if(!name || name === ''){
			g('input-form-label').innerHTML = 'Please Enter a valid Username';
			return;
		}
		if(!pwd || pwd === '' || pwd.length < 8){
			g('input-form-label').innerHTML = 'Please Enter a valid Password of at least 8 characters.';
			return;
		}

		var req = request('POST', url + '/register', { username: name, pwd: pwd }, (val) => {
			if(!req || req.readyState !== 4) return;
			if(req.responseText === 'Registered'){
				//Successfully Registered, Login
				g('btn-login').click();
			}
			else {
				g('input-form-label').innerHTML = req.responseText;
			}
		});

	});

	g('btn-login').addEventListener('click', () => {
		var name = g('username').value;
		var pwd = g('password').value;

		if(!name || name === ''){
			g('input-form-label').innerHTML = 'Please Enter a valid Username';
			return;
		}
		if(!pwd || pwd === '' || pwd.length < 8){
			g('input-form-label').innerHTML = 'Please Enter a valid Password of at least 8 characters.';
			return;
		}

		var req = request('POST', url + '/login', { username: name, pwd: pwd }, (val) => {
			if(!req || req.readyState !== 4) return;
			var res = JSON.parse(req.responseText);
			g('input-form-label').innerHTML = res.desc;
			console.log(res);
			connect(name);
		});

	});
</script>
</html>
