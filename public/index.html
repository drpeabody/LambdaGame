<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>The Lambda Game</title>
	<style type="text/css">
		h1 {
			color: 	#fff;
		}	
		body {
			background: linear-gradient(#224, #112);
		}
		canvas {
			border : 0px;
		}
		#login-form {
			color: #fff;
			margin-top: 20vh;
			text-align: center;
		}
		.row {
			overflow-x: hidden;
			width: 100%;
			margin: 40px 0 0 0;
		}
		.label {
			font-size: 2em;
			margin-bottom: 5vh;
		}
		.btn {
			margin: 1%; 
			padding: 1%;
			display: inline-flex;
			background: #484;
			align-content: center;
			border: none;
			border-radius: 1vw;
			cursor: pointer;
			-webkit-touch-callout: none; /* iOS Safari */
			-webkit-user-select: none; /* Safari */
			-khtml-user-select: none; /* Konqueror HTML */
			-moz-user-select: none; /* Firefox */
			-ms-user-select: none; /* Internet Explorer/Edge */
			user-select: none; /* Non-prefixed version, currently
			                  supported by Chrome and Opera */
		}
	</style>
</head>
<body>
	<div id="login-form">
		<h1> Welcome to the Lambda Game. </h1>
		<label id="input-form-label" class="label">  You must Register or Login to continue. </label>
		<div class="row">
			Username: <input type="text" name="UserName" id="username">
		</div>
		<div class="row">
			Password: <input type="Password" name="Password" id="password">
		</div>
		<div class="row">
			<div class="btn" value="Register" id="btn-register"> Register  </div>
			<div class="btn" value="Login" id="btn-login"> Login  </div>
		</div>
	</div>
	<canvas id="fuckyou"></canvas>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
<script type="text/javascript">
	g = (id) => document.getElementById(id);
	request = (method, url, data, callback) => {
		var httpRequest = new XMLHttpRequest();
		
		if(!httpRequest) {
			alert('Please use a web browser of this age.');
			return false;
		}

		httpRequest.onreadystatechange = callback;
		httpRequest.open(method, url);
    	httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
		httpRequest.send(JSON.stringify(data));
		return httpRequest;
	}
	url = 'http://localhost:8080';

	var hasAskedOnce = false;
	var playerSquareSize = 30;
	var wSRW = 30;
	var hSRW = 30;
	var correctionFactor = 0.95 ;
	var playerSquareDimensions = playerSquareSize ;
	var MapSize = 1000000 ;
	var curId;
	var initCameraX ;
	var initCameraY ;
	canvas = document.getElementById("fuckyou");
	var ctx = canvas.getContext('2d');
	var imageUrls = [];
	imageUrls['tree']='https://res.cloudinary.com/do3uy82tk/image/upload/v1550645217/output-onlinepngtools.png';
	imageUrls['grass']='https://res.cloudinary.com/do3uy82tk/image/upload/v1550772946/grass_block_top_n.png';
	imageUrls['rock']='https://res.cloudinary.com/do3uy82tk/image/upload/v1550657582/Rock.png';
	imageUrls['water']='https://res.cloudinary.com/do3uy82tk/image/upload/v1550772947/WATER2.png';
	imageUrls['snow']='https://res.cloudinary.com/do3uy82tk/image/upload/v1550781217/snow.png';
	imageUrls['sand']='https://res.cloudinary.com/do3uy82tk/image/upload/v1550772947/sand.png';
	imageUrls['playerStandFront']='https://res.cloudinary.com/do3uy82tk/image/upload/v1550785864/Lookup.png';
	imageUrls['playerStandLeft']='https://res.cloudinary.com/do3uy82tk/image/upload/v1550786463/lookleft.png';
	imageUrls['playerStandRight']='https://res.cloudinary.com/do3uy82tk/image/upload/v1550785864/Lookright.png';
	imageUrls['playerStandDown']='https://res.cloudinary.com/do3uy82tk/image/upload/v1550786299/downstand.png';
	imageUrls['playerMoveFront1']='https://res.cloudinary.com/do3uy82tk/image/upload/v1550786690/uprunleft.png';
	imageUrls['playerMoveLeft1']='https://res.cloudinary.com/do3uy82tk/image/upload/v1550786120/leftrunleft.png';
	imageUrls['playerMoveRight1']='https://res.cloudinary.com/do3uy82tk/image/upload/v1550786137/rightrunleft.png';
	imageUrls['playerMoveDown1']='https://res.cloudinary.com/do3uy82tk/image/upload/v1550786299/downwalkleft.png';
	imageUrls['playerMoveFront2']='https://res.cloudinary.com/do3uy82tk/image/upload/v1550786690/uprunright.png';
	imageUrls['playerMoveLeft2']='https://res.cloudinary.com/do3uy82tk/image/upload/v1550786136/leftrunright.png';
	imageUrls['playerMoveRight2']='https://res.cloudinary.com/do3uy82tk/image/upload/v1550786120/rightrunright.png';
	imageUrls['playerMoveDown2']='https://res.cloudinary.com/do3uy82tk/image/upload/v1550786299/downwalkright.png';

	var player = null;
	var hasCameraChangedEver = false ;
	function User(x,y,cameraX, cameraY)
{
	return {
        x : x ,
        y : y ,
        cameraX : cameraX ,
        cameraY : cameraY ,
        bwDown : false ,
        bADown : false ,
        bSDown : false ,
        bDDown : false 
    }
}
	var user = null  ;

	connect = (id) => {
		// io.origins('*:*');
		// socket = io('http://192.168.0.130:8080/', {id: id});
		socket = io(url, {id: id});
		socket.emit('Username', {id: id, windowWidth : (window.innerWidth * correctionFactor), windowHeight : (window.innerHeight*correctionFactor)});
		socket.on('AccountExists', function(doesAccountExist) {
			g('input-form-label').innerHTML = 'This username already exists';
		});
		socket.on('UserId', function(plr){
			var elem = document.getElementById("login-form");
			elem.parentNode.removeChild(elem);
            player = User(plr.x, plr.y, plr.cameraX, plr.cameraY);
            canvas = document.getElementById("fuckyou");
			
			canvas.width = window.innerWidth * correctionFactor;
			canvas.height = window.innerHeight * correctionFactor;
            curId = plr.ID ;
            document.onkeydown = (e) => {
				// console.log("Key Pressed " + e.key);
				var key = e.key ;
				if ((key === 'w')||(key === 'W')) player.bWDown = true ;
				if ((key === 'a')||(key === 'A')) player.bADown = true ;
				if ((key === 's')||(key === 'S')) player.bSDown = true ;
				if ((key === 'd')||(key === 'D')) player.bDDown = true ;
			}

			document.onkeyup = (e) => {
				var key = e.key ;
				if ((key === 'w')||(key === 'W')) player.bWDown = false ;
				if ((key === 'a')||(key === 'A')) player.bADown = false ;
				if ((key === 's')||(key === 'S')) player.bSDown = false ;
				if ((key === 'd')||(key === 'D')) player.bDDown = false ;
			}



			update();

		});
		draw = (data) => {
				
				// Figure out better way ?
				// for (var i = 0 ; i < canvas.width ; i++)
				// {
				// 	for (var j = 0 ; j < canvas.height ; j++)
				// 	{
				// 		if ((player.x + i) >= 0 && (player.x + i) <= MapSize && (player.y + j) >= 0 && (player.y + j) <= MapSize)
				// 		{
				// 			ctx.fillStyle = "#113311";
				// 			ctx.fillRect(i, j, 1, 1);
				// 		}
				// 		else
				// 		{		
				// 			ctx.fillStyle = "#000000";	
				// 			ctx.fillRect(i, j, 1, 1);
				// 		}
				// 	}
				// }
				////Code duplication here should be fixed!!!!!
				if (!hasCameraChangedEver)
				{
					initCameraX = player.cameraX ;
    				initCameraY = player.cameraY ;	
    				hasCameraChangedEver = true;
				}
				var ptrn = ctx.createPattern(grass, 'repeat'); // Create a pattern with this image, and set it to "repeat".
				ctx.fillStyle = ptrn;
				// ctx.fillRect(0,0,canvas.width,canvas.height);
				ctx.save();
    			ctx.translate((initCameraX-player.cameraX), (initCameraY-player.cameraY));
    			ctx.fillRect(0, 0, 100000000,100000000);
    			ctx.restore();
    			
				// if (player.cameraX < 0 )
				// {
				// 	ctx.fillStyle = "#000000";
				// 	ctx.fillRect(0,0,-player.cameraX, canvas.height);
				// }
				// if (player.cameraY < 0 )
				// {
				// 	ctx.fillStyle = "#000000";
				// 	ctx.fillRect(0,0,canvas.width, -player.cameraY);
				// }
				// if (player.cameraY + canvas.height >= MapSize)
				// {
				// 	ctx.fillStyle = "#000000";
				// 	ctx.fillRect(0,MapSize - player.cameraY,canvas.width, canvas.height- (MapSize - player.cameraY));
				// }
				// if (player.cameraX + canvas.width >= MapSize)
				// {
				// 	ctx.fillStyle = "#000000";
				// 	ctx.fillRect(MapSize - player.cameraX, 0, canvas.width - (MapSize - player.cameraX), canvas.height);
				// }
				////////////////////////////FOR SRW
				if(data.weapons["SRW"]){
					console.log("I got the power.")
					ctx.fillStyle = "#111144";
					ctx.fillRect((canvas.width- playerSquareDimensions )/2, (canvas.height- playerSquareDimensions )/2, wSRW, hSRW);
				}


				// ctx.fillStyle = "#111199";
				// ctx.fillRect(tree.x - player.x, tree.y - player.y, 20, 20);
				for (var i = 0 ; i < data.ObjectList.length ; i++)
				{

					// if (data.ObjectList[i].x >= player.cameraX && data.ObjectList[i].x <= (player.cameraX + canvas.width) && data.ObjectList[i].y >= player.cameraY && data.ObjectList[i].y <= (player.cameraY + canvas.height))
					{
						
						console.log("Here");
						switch(data.ObjectList[i].leaf)
						{
							case -1:
								ctx.drawImage(grass, data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y-player.cameraY);
							break ;
							case 1 :
								ctx.drawImage(rock, data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y-player.cameraY);
							break;
							case 2 :
								ctx.drawImage(tree, data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y-player.cameraY);
							break ;
							case 3:
								ctx.fillStyle = "#111144";
								ctx.fillRect(data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y - player.cameraY, data.ObjectList[i].w, data.ObjectList[i].h);
							break;
							case 4 || 5:
								ctx.fillStyle = '#000';
								ctx.fillRect(data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y - player.cameraY, data.ObjectList[i].w, data.ObjectList[i].h);
								break ;
							// case 5:
							// 	ctx.fillStyle ='#000';
			    // 				ctx.fillRect(data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y - player.cameraY, data.ObjectList[i].w, data.ObjectList[i].h);
							// 	break ;
							case 6:
								ctx.drawImage(snow, data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y-player.cameraY);
							break ;
							case 7:
								ctx.drawImage(sand, data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y-player.cameraY);
							break ;
							case 11:
								ctx.drawImage(player11, data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y-player.cameraY);
							break ;
							case 12:
								ctx.drawImage(player12, data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y-player.cameraY);
							break ;
							case 13:
								ctx.drawImage(player13, data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y-player.cameraY);
							break ;
							case 14:
								ctx.drawImage(player14, data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y-player.cameraY);
							break ;
							case 15:
								ctx.drawImage(player15, data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y-player.cameraY);
							break ;
							case 16:
								ctx.drawImage(player16, data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y-player.cameraY);
							break ;
							case 17:
								ctx.drawImage(player17, data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y-player.cameraY);
							break ;
							case 18:
								ctx.drawImage(player18, data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y-player.cameraY);
							break ;
							case 19:
								ctx.drawImage(player19, data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y-player.cameraY);
							break ;
							case 20:
								ctx.drawImage(player20, data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y-player.cameraY);
							break ;
							case 21:
								ctx.drawImage(player21, data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y-player.cameraY);
							break ;
							case 22:
								ctx.drawImage(player22, data.ObjectList[i].x - player.cameraX, data.ObjectList[i].y-player.cameraY);
							break ;
						}

						
					}
					
				}
				if (player.cameraX - initCameraX == 0 && player.cameraY - initCameraY == 0)
    			{
    				initCameraX = player.cameraX ;
    				initCameraY = player.cameraY ;	
    			}
				//update();
			}
			update = () => {
				//Sync with server - All Socet.emit here
				//Process input
				var speed = 5 ;
				var verificationSquareSize = 300 * speed ;
				// Temporary Fix : 
				// if (Math.abs(player.x - data.UserPositionX) <= verificationSquareSize && Math.abs(player.y - data.UserPositionY) <= verificationSquareSize)
				/*if (true)
				{
					console.log("Updating coords");
					console.log(player.x, player.y);
					if (player.bWDown && (player.y - speed>= 0)){
						player.y -= speed; player.cameraY -= speed ;
					}
					if (player.bADown && (player.x - speed>= 0)){
						player.x -= speed; player.cameraX -= speed ;
					}
					if (player.bSDown && (player.y + playerSquareDimensions + speed <= MapSize)){
						player.y += speed; player.cameraY += speed ;
					}
					if (player.bDDown && (player.x + playerSquareDimensions + speed) <= MapSize){ 
						player.x += speed; player.cameraX += speed ;
					}
					socket.emit('UpdateCoords', {x:player.x, y:player.y, ID:curId, cameraX: player.cameraX, cameraY:player.cameraY, canvasWidth:canvas.width, canvasHeight:canvas.height});
				}*/
				socket.emit('UpdateCoords', {bWDown: player.bWDown, bSDown: player.bSDown, bADown:player.bADown, bDDown: player.bDDown, ID:curId, cameraX: player.cameraX, cameraY:player.cameraY, canvasWidth:canvas.width, canvasHeight:canvas.height});
				
				
				requestAnimationFrame(update);

				// Figure out some way of verification server-side
			}
	socket.on('MapGen', function(data) {
			// Clear the div out
			// var elem = document.getElementById("login-form");
			// elem.parentNode.removeChild(elem);
			// Init canvas
			console.log(data)
			player.x = data.UserPositionX;
			player.y = data.UserPositionY;
			player.cameraX = data.UserPositionX + playerSquareDimensions/2 - canvas.width/2;
			player.cameraY = (data.UserPositionY + playerSquareDimensions/2 - canvas.height/2);
			 /*= {
				x: data.UserPositionX, y: data.UserPositionY,
				cameraX: (data.UserPositionX + playerSquareDimensions/2 - canvas.width/2),
				cameraY: (data.UserPositionY + playerSquareDimensions/2 - canvas.height/2),
				bWDown: player.bWDown, bADown: player., bSDown: false, bDDown: false //Input Tracking var
			};*/
			// tree = {
			// 	// x: Math.random()*mapSize, y: Math.random()*mapSize
			// 	x: player.x + 30, y: player.y + 30
			// }

			draw(data);	
		});
}
	g('btn-register').addEventListener('click', () => {
		var name = g('username').value;
		var pwd = g('password').value;

		if(!name || name === ''){
			g('input-form-label').innerHTML = 'Please Enter a valid Username';
			return;
		}
		if(!pwd || pwd === '' || pwd.length < 8){
			g('input-form-label').innerHTML = 'Please Enter a valid Password of at least 8 characters.';
			return;
		}

		var req = request('POST', url + '/register', { username: name, pwd: pwd }, (val) => {
			if(!req || req.readyState !== 4) return;
			if(req.responseText === 'Registered'){
				//Successfully Registered, Login
				g('btn-login').click();
			}
			else {
				g('input-form-label').innerHTML = req.responseText;
			}
		});

	});

	g('btn-login').addEventListener('click', () => {
		var name = g('username').value;
		var pwd = g('password').value;

		if(!name || name === ''){
			g('input-form-label').innerHTML = 'Please Enter a valid Username';
			return;
		}
		if(!pwd || pwd === '' || pwd.length < 8){
			g('input-form-label').innerHTML = 'Please Enter a valid Password of at least 8 characters.';
			return;
		}

		var req = request('POST', url + '/login', { username: name, pwd: pwd }, (val) => {
			if(!req || req.readyState !== 4) return;
			var res = JSON.parse(req.responseText);
			g('input-form-label').innerHTML = res.desc;
			console.log(res);
			connect(name);
		});

	});
</script>
</html>
